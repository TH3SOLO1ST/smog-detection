{% extends "base.html" %}

{% block title %}Dashboard - Islamabad Smog Detection System{% endblock %}

{% block content %}
<div class="row">
    <!-- Current Conditions Card -->
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-thermometer-half me-2"></i>
                    Current Air Quality - Islamabad
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="current-conditions">
                    <!-- Current conditions will be loaded here -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading current conditions...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading current air quality data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Interactive Map -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-map me-2"></i>
                    Air Quality Map
                </h6>
            </div>
            <div class="card-body p-0">
                <div id="map-container" style="height: 500px;">
                    <!-- Map will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Pollutant Details -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-flask me-2"></i>
                    Pollutant Levels
                </h6>
            </div>
            <div class="card-body">
                <div id="pollutant-details">
                    <!-- Pollutant details will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 small text-muted">Loading pollutant data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Historical Trends Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            30-Day Trends
                        </h6>
                    </div>
                    <div class="col-auto">
                        <select class="form-control form-control-sm" id="pollutant-select">
                            <option value="all">All Pollutants</option>
                            <option value="NO2">NO‚ÇÇ</option>
                            <option value="SO2">SO‚ÇÇ</option>
                            <option value="CO">CO</option>
                            <option value="O3">O‚ÇÉ</option>
                            <option value="PM2.5">PM‚ÇÇ.‚ÇÖ</option>
                            <option value="AOD">AOD</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="trends-chart" style="height: 400px;">
                    <!-- Chart will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Health Recommendations -->
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-heart me-2"></i>
                    Health Recommendations
                </h6>
            </div>
            <div class="card-body">
                <div id="health-advice">
                    <!-- Health advice will be loaded here -->
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm text-info" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 small text-muted">Loading health advice...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Quick Actions -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <button class="btn btn-outline-primary btn-block" id="generate-daily-report">
                            <i class="fas fa-file-pdf me-2"></i>
                            Daily Report
                        </button>
                    </div>
                    <div class="col-6 mb-3">
                        <button class="btn btn-outline-success btn-block" id="generate-weekly-report">
                            <i class="fas fa-file-pdf me-2"></i>
                            Weekly Report
                        </button>
                    </div>
                    <div class="col-6 mb-3">
                        <button class="btn btn-outline-info btn-block" id="export-data">
                            <i class="fas fa-download me-2"></i>
                            Export Data
                        </button>
                    </div>
                    <div class="col-6 mb-3">
                        <button class="btn btn-outline-warning btn-block" id="share-dashboard">
                            <i class="fas fa-share-alt me-2"></i>
                            Share
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-server me-2"></i>
                    System Status
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="mr-2">
                                <i class="fas fa-database text-success"></i>
                            </div>
                            <div>
                                <div class="small text-muted">Data Sources</div>
                                <div class="font-weight-bold">Active</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="mr-2">
                                <i class="fas fa-sync text-success"></i>
                            </div>
                            <div>
                                <div class="small text-muted">Last Update</div>
                                <div class="font-weight-bold" id="last-sync-time">Just now</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="mr-2">
                                <i class="fas fa-cloud text-success"></i>
                            </div>
                            <div>
                                <div class="small text-muted">API Status</div>
                                <div class="font-weight-bold">Connected</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="mr-2">
                                <i class="fas fa-chart-bar text-success"></i>
                            </div>
                            <div>
                                <div class="small text-muted">Processing</div>
                                <div class="font-weight-bold">Normal</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Dashboard-specific JavaScript
$(document).ready(function() {
    // Load dashboard data
    loadDashboardData();

    // Auto-refresh every 5 minutes
    setInterval(loadDashboardData, 5 * 60 * 1000);

    // Refresh button
    $('#refresh-btn').click(function() {
        $(this).find('i').addClass('fa-spin');
        loadDashboardData(function() {
            $(this).find('i').removeClass('fa-spin');
        }.bind(this));
    });

    // Pollutant selector
    $('#pollutant-select').change(function() {
        updateTrendsChart($(this).val());
    });

    // Quick action buttons
    $('#generate-daily-report').click(function() {
        generateReport('daily', 'pdf');
    });

    $('#generate-weekly-report').click(function() {
        generateReport('weekly', 'pdf');
    });

    $('#export-data').click(function() {
        exportData();
    });

    $('#share-dashboard').click(function() {
        shareDashboard();
    });
});

function loadDashboardData(callback) {
    // Load current conditions
    $.get('/api/current_conditions')
        .done(function(data) {
            updateCurrentConditions(data);
        })
        .fail(function() {
            showNotification('Failed to load current conditions', 'error');
        });

    // Load map data
    $.get('/api/map_data')
        .done(function(data) {
            initializeMap(data);
        })
        .fail(function() {
            showNotification('Failed to load map data', 'error');
        });

    // Load historical data
    $.get('/api/historical_data')
        .done(function(data) {
            updateTrendsChart('all', data);
        })
        .fail(function() {
            showNotification('Failed to load historical data', 'error');
        });

    // Load alerts
    $.get('/api/alerts')
        .done(function(data) {
            updateAlerts(data.alerts);
        })
        .fail(function() {
            showNotification('Failed to load alerts', 'error');
        });

    if (callback) callback();
}

function updateCurrentConditions(data) {
    var html = '<div class="col-md-3 mb-3">' +
        '<div class="text-center">' +
        '<h2 class="display-4 mb-2" style="color: ' + getOverallStatusColor(data.overall_status) + '">' +
        getStatusEmoji(data.overall_status) + '</h2>' +
        '<h4 class="text-capitalize">' + data.overall_status.replace('_', ' ') + '</h4>' +
        '<p class="text-muted mb-0">Air Quality Status</p>' +
        '<small class="text-muted">Updated: ' + new Date(data.timestamp).toLocaleTimeString() + '</small>' +
        '</div>' +
        '</div>';

    // Add pollutant cards
    var pollutants = ['NO2', 'SO2', 'CO', 'O3', 'PM2.5', 'AOD'];
    pollutants.forEach(function(pollutant, index) {
        if (index < 3) {
            var pollutantData = data.pollutants[pollutant];
            html += '<div class="col-md-3 mb-3">' +
                '<div class="card h-100">' +
                '<div class="card-body text-center">' +
                '<h5 class="card-title">' + pollutant + '</h5>' +
                '<h3 class="card-text" style="color: ' + pollutantData.color + '">' +
                pollutantData.value + '</h3>' +
                '<p class="card-text text-muted">' + pollutantData.unit + '</p>' +
                '<span class="badge badge-pill" style="background-color: ' + pollutantData.color + '">' +
                pollutantData.status.replace('_', ' ') + '</span>' +
                '</div>' +
                '</div>' +
                '</div>';
        }
    });

    $('#current-conditions').html(html);

    // Update pollutant details
    var detailsHtml = '';
    pollutants.forEach(function(pollutant) {
        var pollutantData = data.pollutants[pollutant];
        detailsHtml += '<div class="mb-3 pb-3 border-bottom">' +
            '<div class="d-flex justify-content-between align-items-center">' +
            '<div>' +
            '<strong>' + pollutant + '</strong><br>' +
            '<small class="text-muted">' + pollutantData.unit + '</small>' +
            '</div>' +
            '<div class="text-right">' +
            '<span style="color: ' + pollutantData.color + '; font-size: 1.2rem; font-weight: bold;">' +
            pollutantData.value + '</span><br>' +
            '<small>' + pollutantData.status.replace('_', ' ') + '</small>' +
            '</div>' +
            '</div>' +
            '</div>';
    });

    $('#pollutant-details').html(detailsHtml);

    // Update health advice
    updateHealthAdvice(data.overall_status);

    // Update last update time
    $('#update-time, #last-sync-time').text(new Date(data.timestamp).toLocaleTimeString());
}

function updateHealthAdvice(status) {
    var advice = getHealthAdvice(status);
    var html = '<div class="alert alert-' + advice.alertType + ' mb-3">' +
        '<h6 class="alert-heading">' + advice.title + '</h6>' +
        '<p class="mb-2">' + advice.message + '</p>' +
        '<hr>' +
        '<small class="mb-0">' + advice.recommendations + '</small>' +
        '</div>';

    $('#health-advice').html(html);
}

function updateAlerts(alerts) {
    if (alerts.length === 0) {
        $('#alerts-container').html('');
        return;
    }

    var html = '<div class="alert-container">';
    alerts.forEach(function(alert) {
        var alertClass = alert.type === 'warning' ? 'warning' : 'info';
        var icon = alert.type === 'warning' ? 'exclamation-triangle' : 'info-circle';

        html += '<div class="alert alert-' + alertClass + ' alert-dismissible fade show" role="alert">' +
            '<i class="fas fa-' + icon + ' me-2"></i>' +
            '<strong>' + alert.message + '</strong><br>' +
            '<small class="text-muted">Locations: ' + alert.locations.join(', ') + '</small>' +
            '<button type="button" class="close" data-dismiss="alert">' +
            '<span>&times;</span>' +
            '</button>' +
            '</div>';
    });

    html += '</div>';
    $('#alerts-container').html(html);
}

function initializeMap(data) {
    // Initialize Leaflet map
    var map = L.map('map-container').setView([data.center.lat, data.center.lon], data.zoom);

    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Add location markers
    data.locations.forEach(function(location) {
        var marker = L.marker([location.lat, location.lon]).addTo(map);
        marker.bindPopup(
            '<strong>' + location.name + '</strong><br>' +
            'PM2.5: ' + location.pm25 + ' ¬µg/m¬≥<br>' +
            'NO‚ÇÇ: ' + location.no2 + ' ¬µg/m¬≥<br>' +
            'Status: ' + location.pollution_level.replace('_', ' ')
        );
    });
}

function updateTrendsChart(pollutant, data) {
    if (!data) return;

    var traces = [];

    if (pollutant === 'all') {
        // Show all pollutants
        Object.keys(data.pollutants).forEach(function(key) {
            traces.push({
                x: data.dates,
                y: data.pollutants[key],
                type: 'scatter',
                mode: 'lines+markers',
                name: key,
                line: { width: 2 }
            });
        });
    } else {
        // Show selected pollutant
        traces.push({
            x: data.dates,
            y: data.pollutants[pollutant],
            type: 'scatter',
            mode: 'lines+markers',
            name: pollutant,
            line: { width: 3 }
        });
    }

    var layout = {
        title: 'Air Quality Trends',
        xaxis: { title: 'Date' },
        yaxis: { title: 'Concentration' },
        margin: { t: 50, r: 30, b: 50, l: 60 },
        showlegend: true,
        legend: { x: 0, y: 1 }
    };

    Plotly.newPlot('trends-chart', traces, layout, {responsive: true});
}

function generateReport(type, format) {
    showLoading('Generating ' + type + ' report...', 'This may take a few moments');

    $.get('/api/generate_report', {type: type, format: format})
        .done(function(data) {
            checkReportStatus(data.task_id);
        })
        .fail(function() {
            hideLoading();
            showNotification('Failed to generate report', 'error');
        });
}

function checkReportStatus(taskId) {
    $.get('/api/report_status/' + taskId)
        .done(function(data) {
            if (data.state === 'PENDING') {
                setTimeout(function() {
                    checkReportStatus(taskId);
                }, 2000);
            } else if (data.state === 'SUCCESS') {
                hideLoading();
                showNotification('Report generated successfully!', 'success');
                // Optionally download the report
                if (data.result && data.result.file_path) {
                    window.open(data.result.file_path, '_blank');
                }
            } else {
                hideLoading();
                showNotification('Report generation failed', 'error');
            }
        })
        .fail(function() {
            hideLoading();
            showNotification('Failed to check report status', 'error');
        });
}

function exportData() {
    showLoading('Exporting data...', 'Preparing your data download');

    $.get('/api/export_data')
        .done(function(data) {
            hideLoading();
            showNotification('Data exported successfully!', 'success');
            // Trigger download
            window.open(data.file_url, '_blank');
        })
        .fail(function() {
            hideLoading();
            showNotification('Failed to export data', 'error');
        });
}

function shareDashboard() {
    var url = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: 'Islamabad Air Quality Dashboard',
            text: 'Check current air quality conditions in Islamabad',
            url: url
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(url).then(function() {
            showNotification('Dashboard link copied to clipboard!', 'success');
        });
    }
}

// Utility functions
function getOverallStatusColor(status) {
    var colors = {
        'good': '#4CAF50',
        'moderate': '#FFC107',
        'unhealthy_sensitive': '#FF9800',
        'unhealthy': '#F44336',
        'very_unhealthy': '#9C27B0',
        'hazardous': '#4A148C'
    };
    return colors[status] || '#9E9E9E';
}

function getStatusEmoji(status) {
    var emojis = {
        'good': 'üòä',
        'moderate': 'üòê',
        'unhealthy_sensitive': 'üò∑',
        'unhealthy': 'ü§¢',
        'very_unhealthy': 'üòµ',
        'hazardous': '‚ò†Ô∏è'
    };
    return emojis[status] || '‚ùì';
}

function getHealthAdvice(status) {
    var adviceMap = {
        'good': {
            title: 'Good Air Quality',
            message: 'Air quality is satisfactory and poses little or no risk.',
            recommendations: 'Enjoy your outdoor activities!',
            alertType: 'success'
        },
        'moderate': {
            title: 'Moderate Air Quality',
            message: 'Air quality is acceptable for most people.',
            recommendations: 'Sensitive individuals may experience minor issues. Limit prolonged outdoor exertion.',
            alertType: 'warning'
        },
        'unhealthy_sensitive': {
            title: 'Unhealthy for Sensitive Groups',
            message: 'Members of sensitive groups may experience health effects.',
            recommendations: 'Children, elderly, and people with heart/lung disease should limit prolonged outdoor exertion.',
            alertType: 'warning'
        },
        'unhealthy': {
            title: 'Unhealthy Air Quality',
            message: 'Everyone may begin to experience health effects.',
            recommendations: 'Avoid prolonged outdoor exertion. Consider wearing a mask if you must go outside.',
            alertType: 'danger'
        },
        'very_unhealthy': {
            title: 'Very Unhealthy Air Quality',
            message: 'Health warnings of emergency conditions.',
            recommendations: 'Avoid all outdoor activities. Stay indoors and keep windows closed.',
            alertType: 'danger'
        },
        'hazardous': {
            title: 'Hazardous Air Quality',
            message: 'Emergency conditions affecting entire population.',
            recommendations: 'Stay indoors, avoid all outdoor activities, use air purifiers if available.',
            alertType: 'danger'
        }
    };

    return adviceMap[status] || adviceMap['moderate'];
}

function showLoading(message, detail) {
    $('#loading-message').text(message);
    $('#loading-detail').text(detail);
    $('#loadingModal').modal('show');
}

function hideLoading() {
    $('#loadingModal').modal('hide');
}

function showNotification(message, type) {
    var alertClass = type === 'error' ? 'danger' : type;
    var notification = '<div class="alert alert-' + alertClass + ' alert-dismissible fade show" role="alert">' +
        message +
        '<button type="button" class="close" data-dismiss="alert">' +
        '<span>&times;</span>' +
        '</button>' +
        '</div>';

    $('#alerts-container').prepend(notification);

    // Auto-dismiss after 5 seconds
    setTimeout(function() {
        $('.alert').first().alert('close');
    }, 5000);
}
</script>
{% endblock %}